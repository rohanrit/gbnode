<!doctype html>
<html>
  <head>
    <title>Site Generator</title>
  </head>
  <body>
    <h1>Static Site Generator</h1>
    <form id="generatorForm">
      <h3>Select Sections:</h3>
      <div id="sections"></div>

      <h3>Bootstrap Customization:</h3>
      <div id="bootstrapConfig"></div>

      <button type="submit">Generate Site</button>
    </form>

    <div id="result"></div>
    <div id="siteList" style="margin-top: 20px"></div>
    <script>
      // Handle form submission
      document
        .getElementById("generatorForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          // Collect selected sections
          const sections = formData.getAll("sections");

          // Collect all bootstrap customization inputs dynamically
          const bootstrapConfig = {};
          formData.forEach((value, key) => {
            if (key !== "sections") {
              bootstrapConfig[key] = value;
            }
          });

          // Send build request
          const res = await fetch("/build", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sections, bootstrapConfig }),
          });
          const data = await res.json();

          const resultDiv = document.getElementById("result"); // ✅ fixed missing reference
          if (data.success) {
            resultDiv.innerHTML = `
        <p>✅ Site generated successfully!</p>
        <a href="${data.output}" target="_blank">
          <button type="button">View Generated Page</button>
        </a>
      `;

            // Refresh generated sites list
            loadSites();
          } else {
            alert("Error: " + data.error);
          }
        });

      // Function to load generated sites list
      async function loadSites() {
        const res = await fetch("/sites.json");
        if (res.ok) {
          const sites = await res.json();
          const listDiv = document.getElementById("siteList");
          if (sites.length > 0) {
            listDiv.innerHTML =
              "<h3>Generated Sites</h3><ul>" +
              sites
                .map(
                  (s) => `
                <li>
                  <a href="${s.path}" target="_blank">${s.id}</a>
                  <small>(${new Date(s.timestamp).toLocaleString()})</small>
                </li>
              `,
                )
                .join("") +
              "</ul>";
          } else {
            listDiv.innerHTML = "<p>No sites generated yet.</p>";
          }
        }
      }

      // Load sites list on page load
      loadSites();

      // Function to load available sections dynamically
      async function loadSections() {
        const res = await fetch("/sections");
        const sections = await res.json();
        const container = document.getElementById("sections");
        container.innerHTML =
          "<h3>Select Sections:</h3>" +
          sections
            .map(
              (s) => `
            <label>
              <input type="checkbox" name="sections" value="${s.name}">
              ${s.label} (${s.category})
            </label><br>
          `,
            )
            .join("");
      }
      loadSections();

      // Function to load bootstrap customization variables dynamically
      async function loadBootstrapVars() {
        const res = await fetch("/bootstrap-variables");
        const vars = await res.json();
        const container = document.getElementById("bootstrapConfig");
        container.innerHTML =
          "<h3>Bootstrap Customization:</h3>" +
          vars
            .map(
              (v) => `
            <label>
              ${v.label}: 
              <input type="${v.type}" name="${v.name}" value="${v.default}">
            </label><br>
          `,
            )
            .join("");
      }
      loadBootstrapVars();
    </script>
  </body>
</html>
